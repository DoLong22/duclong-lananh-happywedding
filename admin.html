<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Qu·∫£n L√Ω Kh√°ch M·ªùi - Wedding Admin</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #f5f0e8 0%, #e8ded0 100%);
        min-height: 100vh;
        padding: 20px;
      }

      .container {
        max-width: 1000px;
        margin: 0 auto;
      }

      /* Login Screen */
      .login-screen {
        max-width: 400px;
        margin: 100px auto;
        background: white;
        padding: 40px;
        border-radius: 15px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      }

      .login-screen h1 {
        color: #a8926d;
        margin-bottom: 30px;
        text-align: center;
      }

      .login-screen input {
        width: 100%;
        padding: 15px;
        border: 2px solid #e8ded0;
        border-radius: 8px;
        font-size: 16px;
        margin-bottom: 15px;
      }

      .login-screen button {
        width: 100%;
        padding: 15px;
        background: #a8926d;
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        cursor: pointer;
        font-weight: 600;
      }

      .login-screen button:hover {
        background: #8b7a63;
      }

      .error-msg {
        color: #d32f2f;
        font-size: 14px;
        margin-top: 10px;
        text-align: center;
      }

      /* Admin Panel */
      .admin-panel {
        display: none;
      }

      .header {
        background: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .header h1 {
        color: #a8926d;
        font-size: 2rem;
      }

      .logout-btn {
        padding: 10px 20px;
        background: #d32f2f;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
      }

      .logout-btn:hover {
        background: #b71c1c;
      }

      .stats {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: white;
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        text-align: center;
      }

      .stat-card h3 {
        color: #666;
        font-size: 0.9rem;
        margin-bottom: 10px;
      }

      .stat-card .number {
        color: #a8926d;
        font-size: 2.5rem;
        font-weight: 700;
      }

      .section {
        background: white;
        padding: 30px;
        border-radius: 15px;
        margin-bottom: 30px;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
      }

      .section h2 {
        color: #a8926d;
        margin-bottom: 20px;
        font-size: 1.5rem;
      }

      .input-group {
        display: grid;
        grid-template-columns: 1fr auto;
        gap: 15px;
        margin-bottom: 20px;
      }

      .input-group input {
        padding: 12px 15px;
        border: 2px solid #e8ded0;
        border-radius: 8px;
        font-size: 15px;
      }

      .input-group input:focus {
        outline: none;
        border-color: #a8926d;
      }

      .btn {
        padding: 12px 25px;
        background: #a8926d;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
        transition: background 0.3s;
      }

      .btn:hover {
        background: #8b7a63;
      }

      .btn-secondary {
        background: #5f7a71;
      }

      .btn-secondary:hover {
        background: #4a6259;
      }

      .btn-danger {
        background: #d32f2f;
      }

      .btn-danger:hover {
        background: #b71c1c;
      }

      .bulk-input {
        width: 100%;
        min-height: 120px;
        padding: 12px;
        border: 2px solid #e8ded0;
        border-radius: 8px;
        font-size: 15px;
        font-family: inherit;
        margin-bottom: 15px;
        resize: vertical;
      }

      .bulk-input:focus {
        outline: none;
        border-color: #a8926d;
      }

      .guest-list {
        margin-top: 20px;
      }

      .guest-item {
        background: #f9f7f4;
        padding: 20px;
        border-radius: 10px;
        margin-bottom: 15px;
        border-left: 4px solid #a8926d;
      }

      .guest-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
      }

      .guest-name {
        font-size: 1.2rem;
        font-weight: 600;
        color: #5f5244;
      }

      .guest-actions {
        display: flex;
        gap: 10px;
      }

      .guest-actions button {
        padding: 6px 12px;
        font-size: 0.85rem;
      }

      .guest-url {
        background: white;
        padding: 10px 15px;
        border-radius: 6px;
        font-size: 0.9rem;
        color: #666;
        word-break: break-all;
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 10px;
      }

      .copy-btn {
        padding: 5px 15px;
        background: #a8926d;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        white-space: nowrap;
        font-size: 0.85rem;
      }

      .copy-btn:hover {
        background: #8b7a63;
      }

      .copy-btn.copied {
        background: #4caf50;
      }

      .bulk-actions {
        display: flex;
        gap: 15px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: #999;
      }

      .empty-state svg {
        width: 80px;
        height: 80px;
        margin-bottom: 20px;
        opacity: 0.3;
      }

      /* RSVP Table Styles */
      .rsvp-table-container {
        overflow-x: auto;
        margin-top: 20px;
      }

      .rsvp-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      }

      .rsvp-table thead {
        background: #a8926d;
        color: white;
      }

      .rsvp-table th {
        padding: 15px 12px;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        white-space: nowrap;
      }

      .rsvp-table td {
        padding: 12px;
        border-bottom: 1px solid #e8ded0;
        font-size: 0.9rem;
        vertical-align: top;
      }

      .rsvp-table tbody tr:hover {
        background: #f9f7f4;
      }

      .rsvp-table tbody tr:last-child td {
        border-bottom: none;
      }

      .rsvp-status-badge {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        white-space: nowrap;
      }

      .rsvp-status-badge.attending {
        background: #e8f5e9;
        color: #2e7d32;
      }

      .rsvp-status-badge.not-attending {
        background: #ffebee;
        color: #c62828;
      }

      .rsvp-side-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
      }

      .rsvp-side-badge.groom {
        background: #e3f2fd;
        color: #1565c0;
      }

      .rsvp-side-badge.bride {
        background: #fce4ec;
        color: #c2185b;
      }

      .rsvp-transport-badge {
        padding: 5px 12px;
        border-radius: 12px;
        font-size: 0.8rem;
        font-weight: 600;
        display: inline-block;
        white-space: nowrap;
      }

      .rsvp-transport-badge.group {
        background: #e3f2fd;
        color: #1565c0;
      }

      .rsvp-transport-badge.self {
        background: #fff3e0;
        color: #e65100;
      }

      .rsvp-pickup-badge {
        padding: 4px 10px;
        border-radius: 10px;
        font-size: 0.75rem;
        font-weight: 600;
        display: inline-block;
        background: #f3e5f5;
        color: #6a1b9a;
      }

      .rsvp-note-cell {
        max-width: 200px;
        white-space: normal;
        font-size: 0.85rem;
        color: #666;
      }

      .rsvp-timestamp-cell {
        font-size: 0.8rem;
        color: #999;
        white-space: nowrap;
      }

      @media (max-width: 768px) {
        .header {
          flex-direction: column;
          gap: 15px;
          text-align: center;
        }

        .input-group {
          grid-template-columns: 1fr;
        }

        .guest-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 10px;
        }

        .guest-url {
          flex-direction: column;
          align-items: stretch;
        }

        .bulk-actions {
          flex-direction: column;
        }

        .rsvp-table {
          font-size: 0.8rem;
        }

        .rsvp-table th,
        .rsvp-table td {
          padding: 8px 6px;
        }

        .rsvp-note-cell {
          max-width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Login Screen -->
    <div class="login-screen" id="loginScreen">
      <h1>üîê ƒêƒÉng Nh·∫≠p Admin</h1>
      <input type="password" id="passwordInput" placeholder="Nh·∫≠p m·∫≠t kh·∫©u" />
      <button onclick="login()">ƒêƒÉng Nh·∫≠p</button>
      <div class="error-msg" id="errorMsg"></div>
    </div>

    <!-- Admin Panel -->
    <div class="admin-panel" id="adminPanel">
      <div class="container">
        <div class="header">
          <h1>üíí Qu·∫£n L√Ω Kh√°ch M·ªùi Wedding</h1>
          <button class="logout-btn" onclick="logout()">ƒêƒÉng Xu·∫•t</button>
        </div>

        <div class="stats">
          <div class="stat-card">
            <h3>T·ªïng S·ªë Kh√°ch</h3>
            <div class="number" id="totalGuests">0</div>
          </div>
          <div class="stat-card">
            <h3>Base URL</h3>
            <div
              style="font-size: 0.9rem; color: #666; margin-top: 10px"
              id="baseUrl"
            >
              -
            </div>
          </div>
        </div>

        <div class="section">
          <h2>‚ûï Th√™m Kh√°ch M·ªõi</h2>
          <div class="input-group">
            <input
              type="text"
              id="guestNameInput"
              placeholder="Nh·∫≠p t√™n kh√°ch (VD: Nguy·ªÖn VƒÉn A)"
            />
            <button class="btn" onclick="addGuest()">Th√™m</button>
          </div>
          <div
            style="
              margin: 15px 0;
              padding: 15px;
              background: #f9f7f4;
              border-radius: 8px;
            "
          >
            <label
              style="
                display: flex;
                align-items: center;
                cursor: pointer;
                font-size: 15px;
              "
            >
              <input
                type="checkbox"
                id="brideVenueCheckbox"
                style="
                  width: 20px;
                  height: 20px;
                  margin-right: 10px;
                  cursor: pointer;
                "
              />
              <span style="color: #5f5244; font-weight: 600"
                >üè† Kh√°ch m·ªùi nh√† g√°i ƒÉn c·ªó tr∆∞·ªõc (18:00 - 27/12/2025)</span
              >
            </label>
            <p style="margin: 8px 0 0 30px; color: #999; font-size: 0.85rem">
              ƒê·ªãa ch·ªâ: T∆∞ gia nh√† g√°i, X√£ B·∫°ch ƒê·∫±ng, H∆∞ng Y√™n
            </p>
          </div>
          <p style="color: #666; font-size: 0.9rem">
            Ho·∫∑c th√™m nhi·ªÅu kh√°ch c√πng l√∫c (m·ªói d√≤ng m·ªôt t√™n):
          </p>
          <textarea
            class="bulk-input"
            id="bulkInput"
            placeholder="Nguy·ªÖn VƒÉn A&#10;Tr·∫ßn Th·ªã B&#10;L√™ VƒÉn C"
          ></textarea>
          <div
            style="
              margin: 15px 0;
              padding: 15px;
              background: #f9f7f4;
              border-radius: 8px;
            "
          >
            <label
              style="
                display: flex;
                align-items: center;
                cursor: pointer;
                font-size: 15px;
              "
            >
              <input
                type="checkbox"
                id="bulkBrideVenueCheckbox"
                style="
                  width: 20px;
                  height: 20px;
                  margin-right: 10px;
                  cursor: pointer;
                "
              />
              <span style="color: #5f5244; font-weight: 600"
                >üè† Kh√°ch m·ªùi nh√† g√°i ƒÉn c·ªó tr∆∞·ªõc (18:00 - 27/12/2025)</span
              >
            </label>
          </div>
          <button class="btn btn-secondary" onclick="addBulkGuests()">
            Th√™m Nhi·ªÅu Kh√°ch
          </button>
        </div>

        <div class="section">
          <h2>üìã Danh S√°ch Kh√°ch M·ªùi (<span id="guestCount">0</span> kh√°ch)</h2>
          <div class="bulk-actions">
            <button class="btn btn-secondary" onclick="copyAllUrls()">
              üìã Copy T·∫•t C·∫£ URLs
            </button>
            <button class="btn btn-secondary" onclick="downloadUrls()">
              üíæ Download File
            </button>
            <button class="btn btn-danger" onclick="deleteAllGuests()">
              üóëÔ∏è X√≥a T·∫•t C·∫£
            </button>
          </div>
          <div class="guest-list" id="guestList">
            <div class="empty-state">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                <circle cx="9" cy="7" r="4"></circle>
                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
              </svg>
              <p>Ch∆∞a c√≥ kh√°ch m·ªùi n√†o. H√£y th√™m kh√°ch m·ªõi!</p>
            </div>
          </div>
        </div>

        <!-- RSVP Responses Section -->
        <div class="section">
          <h2>üíå Ph·∫£n H·ªìi RSVP</h2>

          <!-- RSVP Statistics -->
          <div class="stats" style="margin-bottom: 25px">
            <div class="stat-card">
              <h3>T·ªïng Ph·∫£n H·ªìi</h3>
              <div class="number" id="totalRsvps">0</div>
            </div>
            <div class="stat-card">
              <h3>‚úÖ Tham D·ª±</h3>
              <div class="number" style="color: #4caf50" id="attendingCount">
                0
              </div>
              <div style="font-size: 0.9rem; color: #666; margin-top: 5px">
                <span id="attendingGuests">0</span> kh√°ch
              </div>
            </div>
            <div class="stat-card">
              <h3>‚ùå Kh√¥ng Tham D·ª±</h3>
              <div class="number" style="color: #f44336" id="notAttendingCount">
                0
              </div>
            </div>
            <div class="stat-card">
              <h3>üöó ƒê√≥n Xe</h3>
              <div
                class="number"
                style="color: #2196f3"
                id="groupTransportCount"
              >
                0
              </div>
            </div>
          </div>

          <!-- Filter and Search -->
          <div
            style="
              margin-bottom: 20px;
              display: flex;
              gap: 10px;
              flex-wrap: wrap;
            "
          >
            <input
              type="text"
              id="rsvpSearch"
              placeholder="üîç T√¨m ki·∫øm theo t√™n..."
              style="
                flex: 1;
                min-width: 200px;
                padding: 10px 15px;
                border: 2px solid #e8ded0;
                border-radius: 8px;
                font-size: 15px;
              "
            />
            <select
              id="attendanceFilter"
              onchange="filterRsvps()"
              style="
                padding: 10px 15px;
                border: 2px solid #e8ded0;
                border-radius: 8px;
                font-size: 15px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="all">T·∫•t c·∫£</option>
              <option value="yes">Tham d·ª±</option>
              <option value="no">Kh√¥ng tham d·ª±</option>
            </select>
            <select
              id="sideFilter"
              onchange="filterRsvps()"
              style="
                padding: 10px 15px;
                border: 2px solid #e8ded0;
                border-radius: 8px;
                font-size: 15px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="all">C·∫£ hai b√™n</option>
              <option value="groom">Nh√† trai</option>
              <option value="bride">Nh√† g√°i</option>
            </select>
            <select
              id="transportFilter"
              onchange="filterRsvps()"
              style="
                padding: 10px 15px;
                border: 2px solid #e8ded0;
                border-radius: 8px;
                font-size: 15px;
                background: white;
                cursor: pointer;
              "
            >
              <option value="all">Ph∆∞∆°ng ti·ªán</option>
              <option value="group">ƒê√≥n xe</option>
              <option value="self">T·ª± ƒëi</option>
            </select>
          </div>

          <!-- Export Button -->
          <div style="margin-bottom: 20px">
            <button class="btn btn-secondary" onclick="exportRsvpData()">
              üìä Xu·∫•t Excel
            </button>
          </div>

          <!-- RSVP List -->
          <div id="rsvpList">
            <div class="empty-state">
              <svg
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
              >
                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                <line x1="16" y1="2" x2="16" y2="6"></line>
                <line x1="8" y1="2" x2="8" y2="6"></line>
                <line x1="3" y1="10" x2="21" y2="10"></line>
              </svg>
              <p>Ch∆∞a c√≥ ph·∫£n h·ªìi RSVP n√†o.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script type="module">
      import { firebaseConfig } from './js/config.js';
      import { URLParamsEncoder } from './js/url-params.js';
      import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
      import {
        getDatabase,
        ref,
        push,
        set,
        onValue,
        remove,
      } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js';

      // Initialize Firebase
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const guestsRef = ref(db, 'guests');
      const rsvpRef = ref(db, 'rsvp');

      // Store RSVP data for filtering
      let allRsvpData = [];

      // Password
      const ADMIN_PASSWORD = 'longlanh2025@';

      // Global functions
      window.login = function () {
        const password = document.getElementById('passwordInput').value;
        const errorMsg = document.getElementById('errorMsg');

        if (password === ADMIN_PASSWORD) {
          sessionStorage.setItem('adminAuth', 'true');
          document.getElementById('loginScreen').style.display = 'none';
          document.getElementById('adminPanel').style.display = 'block';
          loadGuests();
          loadRsvpData();
        } else {
          errorMsg.textContent = 'M·∫≠t kh·∫©u kh√¥ng ƒë√∫ng!';
        }
      };

      window.logout = function () {
        sessionStorage.removeItem('adminAuth');
        location.reload();
      };

      window.addGuest = async function () {
        const nameInput = document.getElementById('guestNameInput');
        const name = nameInput.value.trim();
        const isBrideVenue =
          document.getElementById('brideVenueCheckbox').checked;

        if (!name) {
          alert('Vui l√≤ng nh·∫≠p t√™n kh√°ch!');
          return;
        }

        try {
          const newGuestRef = push(guestsRef);
          const venue = isBrideVenue ? 'bride' : 'groom';
          const guestUrl = generateUrl(name, venue);

          await set(newGuestRef, {
            name: name,
            url: guestUrl,
            venue: venue,
            createdAt: Date.now(),
          });

          nameInput.value = '';
          document.getElementById('brideVenueCheckbox').checked = false;
          alert(
            '‚úÖ ƒê√£ th√™m kh√°ch: ' + name + (isBrideVenue ? ' (Nh√† g√°i)' : '')
          );
        } catch (error) {
          console.error('Error adding guest:', error);
          alert('‚ùå L·ªói khi th√™m kh√°ch!');
        }
      };

      window.addBulkGuests = async function () {
        const bulkInput = document.getElementById('bulkInput');
        const names = bulkInput.value
          .split('\n')
          .map((n) => n.trim())
          .filter((n) => n);
        const isBrideVenue = document.getElementById(
          'bulkBrideVenueCheckbox'
        ).checked;

        if (names.length === 0) {
          alert('Vui l√≤ng nh·∫≠p danh s√°ch t√™n!');
          return;
        }

        try {
          const venue = isBrideVenue ? 'bride' : 'groom';

          for (const name of names) {
            const newGuestRef = push(guestsRef);
            const guestUrl = generateUrl(name, venue);

            await set(newGuestRef, {
              name: name,
              url: guestUrl,
              venue: venue,
              createdAt: Date.now(),
            });
          }

          bulkInput.value = '';
          document.getElementById('bulkBrideVenueCheckbox').checked = false;
          alert(
            `‚úÖ ƒê√£ th√™m ${names.length} kh√°ch th√†nh c√¥ng!` +
              (isBrideVenue ? ' (Nh√† g√°i)' : '')
          );
        } catch (error) {
          console.error('Error adding bulk guests:', error);
          alert('‚ùå L·ªói khi th√™m kh√°ch!');
        }
      };

      window.deleteGuest = async function (guestId, guestName) {
        if (confirm(`X√≥a kh√°ch: ${guestName}?`)) {
          try {
            await remove(ref(db, 'guests/' + guestId));
            alert('‚úÖ ƒê√£ x√≥a kh√°ch!');
          } catch (error) {
            console.error('Error deleting guest:', error);
            alert('‚ùå L·ªói khi x√≥a kh√°ch!');
          }
        }
      };

      window.deleteAllGuests = async function () {
        if (confirm('‚ö†Ô∏è X√ìA T·∫§T C·∫¢ kh√°ch m·ªùi? Kh√¥ng th·ªÉ ho√†n t√°c!')) {
          if (confirm('B·∫°n ch·∫Øc ch·∫Øn ch·ª©? Nh·∫•n OK ƒë·ªÉ x√°c nh·∫≠n x√≥a h·∫øt!')) {
            try {
              await remove(guestsRef);
              alert('‚úÖ ƒê√£ x√≥a t·∫•t c·∫£ kh√°ch!');
            } catch (error) {
              console.error('Error deleting all guests:', error);
              alert('‚ùå L·ªói khi x√≥a!');
            }
          }
        }
      };

      window.copyUrl = function (url, btnElement) {
        navigator.clipboard.writeText(url).then(() => {
          const originalText = btnElement.textContent;
          btnElement.textContent = '‚úì ƒê√£ Copy';
          btnElement.classList.add('copied');
          setTimeout(() => {
            btnElement.textContent = originalText;
            btnElement.classList.remove('copied');
          }, 2000);
        });
      };

      window.copyAllUrls = function () {
        const urlElements = document.querySelectorAll('.guest-url span');
        const urls = Array.from(urlElements)
          .map((el) => el.textContent)
          .join('\n');

        if (urls) {
          navigator.clipboard.writeText(urls).then(() => {
            alert('‚úÖ ƒê√£ copy t·∫•t c·∫£ URLs!');
          });
        }
      };

      window.downloadUrls = function () {
        const urlElements = document.querySelectorAll('.guest-url');
        let content = 'DANH S√ÅCH LINK THI·ªÜP C∆Ø·ªöI\n';
        content += '='.repeat(50) + '\n\n';

        urlElements.forEach((el, index) => {
          const name =
            el.parentElement.querySelector('.guest-name').textContent;
          const url = el.querySelector('span').textContent;
          content += `${index + 1}. ${name}\n${url}\n\n`;
        });

        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'danh-sach-khach-moi.txt';
        link.click();
      };

      function generateUrl(name, venue = 'groom') {
        const baseUrl =
          'https://duclong-lananh-happywedding.vercel.app' +
          window.location.pathname.replace('admin.html', 'index.html');

        // Use encrypted URL parameters
        const params = {
          guest: name,
          venue: venue,
        };

        return URLParamsEncoder.generateUrl(baseUrl, params);
      }

      function loadGuests() {
        document.getElementById('baseUrl').textContent = window.location.origin;

        onValue(guestsRef, (snapshot) => {
          const guests = snapshot.val();
          const guestListDiv = document.getElementById('guestList');

          if (!guests) {
            guestListDiv.innerHTML = `
                        <div class="empty-state">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            <p>Ch∆∞a c√≥ kh√°ch m·ªùi n√†o. H√£y th√™m kh√°ch m·ªõi!</p>
                        </div>
                    `;
            document.getElementById('totalGuests').textContent = '0';
            document.getElementById('guestCount').textContent = '0';
            return;
          }

          const guestArray = Object.entries(guests).map(([id, data]) => ({
            id,
            ...data,
          }));
          guestArray.sort((a, b) => b.createdAt - a.createdAt);

          document.getElementById('totalGuests').textContent =
            guestArray.length;
          document.getElementById('guestCount').textContent = guestArray.length;

          guestListDiv.innerHTML = guestArray
            .map(
              (guest) => `
                    <div class="guest-item">
                        <div class="guest-header">
                            <div class="guest-name">${guest.name}</div>
                            <div class="guest-actions">
                                <button class="btn btn-danger" onclick="deleteGuest('${guest.id}', '${guest.name}')">X√≥a</button>
                            </div>
                        </div>
                        <div class="guest-url">
                            <span>${guest.url}</span>
                            <button class="copy-btn" onclick="copyUrl('${guest.url}', this)">Copy</button>
                        </div>
                    </div>
                `
            )
            .join('');
        });
      }

      // Load RSVP data
      function loadRsvpData() {
        onValue(rsvpRef, (snapshot) => {
          const rsvps = snapshot.val();

          if (!rsvps) {
            allRsvpData = [];
            updateRsvpStats();
            displayRsvps([]);
            return;
          }

          allRsvpData = Object.entries(rsvps).map(([id, data]) => ({
            id,
            ...data,
          }));
          allRsvpData.sort(
            (a, b) => new Date(b.timestamp) - new Date(a.timestamp)
          );

          updateRsvpStats();
          filterRsvps();
        });
      }

      // Update RSVP statistics
      function updateRsvpStats() {
        const totalRsvps = allRsvpData.length;
        const attending = allRsvpData.filter((r) => r.attendance === 'yes');
        const notAttending = allRsvpData.filter((r) => r.attendance === 'no');
        const groupTransport = allRsvpData.filter(
          (r) => r.transport === 'group'
        );

        const totalGuests = attending.reduce(
          (sum, r) => sum + (parseInt(r.guestCount) || 0),
          0
        );

        document.getElementById('totalRsvps').textContent = totalRsvps;
        document.getElementById('attendingCount').textContent =
          attending.length;
        document.getElementById('attendingGuests').textContent = totalGuests;
        document.getElementById('notAttendingCount').textContent =
          notAttending.length;
        document.getElementById('groupTransportCount').textContent =
          groupTransport.length;
      }

      // Filter RSVPs
      window.filterRsvps = function () {
        const searchTerm = document
          .getElementById('rsvpSearch')
          .value.toLowerCase();
        const attendanceFilter =
          document.getElementById('attendanceFilter').value;
        const sideFilter = document.getElementById('sideFilter').value;
        const transportFilter =
          document.getElementById('transportFilter').value;

        let filtered = allRsvpData;

        // Search by name
        if (searchTerm) {
          filtered = filtered.filter((r) =>
            r.name.toLowerCase().includes(searchTerm)
          );
        }

        // Filter by attendance
        if (attendanceFilter !== 'all') {
          filtered = filtered.filter((r) => r.attendance === attendanceFilter);
        }

        // Filter by side
        if (sideFilter !== 'all') {
          filtered = filtered.filter((r) => r.guestSide === sideFilter);
        }

        // Filter by transport
        if (transportFilter !== 'all') {
          filtered = filtered.filter((r) => r.transport === transportFilter);
        }

        displayRsvps(filtered);
      };

      // Display RSVPs
      function displayRsvps(rsvps) {
        const rsvpListDiv = document.getElementById('rsvpList');

        if (rsvps.length === 0) {
          rsvpListDiv.innerHTML = `
                    <div class="empty-state">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <p>Kh√¥ng t√¨m th·∫•y ph·∫£n h·ªìi n√†o.</p>
                    </div>
                `;
          return;
        }

        const pickupLabels = {
          'cau-giay': 'C·∫ßu Gi·∫•y',
          'ha-dong': 'H√† ƒê√¥ng',
          'thai-thinh': 'Th√°i Th·ªãnh',
          'thanh-tri': 'Thanh Tr√¨',
        };

        const tableRows = rsvps
          .map((rsvp, index) => {
            const isAttending = rsvp.attendance === 'yes';
            const sideClass = rsvp.guestSide === 'groom' ? 'groom' : 'bride';
            const sideLabel =
              rsvp.guestSide === 'groom' ? 'Nh√† trai' : 'Nh√† g√°i';

            // Transport badge
            let transportHTML = '-';
            if (isAttending) {
              if (rsvp.transport === 'group') {
                transportHTML =
                  '<span class="rsvp-transport-badge group">üöó ƒê√≥n xe</span>';
              } else if (rsvp.transport === 'self') {
                transportHTML =
                  '<span class="rsvp-transport-badge self">üö∂ T·ª± ƒëi</span>';
              }
            }

            // Pickup location badge
            let pickupHTML = '-';
            if (
              isAttending &&
              rsvp.transport === 'group' &&
              rsvp.pickupLocation
            ) {
              const pickupLabel =
                pickupLabels[rsvp.pickupLocation] || rsvp.pickupLocation;
              pickupHTML = `<span class="rsvp-pickup-badge">üìç ${pickupLabel}</span>`;
            }

            const date = new Date(rsvp.timestamp);
            const formattedDate = date.toLocaleString('vi-VN', {
              day: '2-digit',
              month: '2-digit',
              year: 'numeric',
              hour: '2-digit',
              minute: '2-digit',
            });

            return `
                    <tr>
                        <td style="text-align: center;">${index + 1}</td>
                        <td><strong>${rsvp.name}</strong></td>
                        <td>
                            <span class="rsvp-status-badge ${
                              isAttending ? 'attending' : 'not-attending'
                            }">
                                ${
                                  isAttending
                                    ? '‚úÖ Tham d·ª±'
                                    : '‚ùå Kh√¥ng tham d·ª±'
                                }
                            </span>
                        </td>
                        <td>
                            <span class="rsvp-side-badge ${sideClass}">
                                ${sideLabel}
                            </span>
                        </td>
                        <td style="text-align: center;">${
                          isAttending ? rsvp.guestCount : '-'
                        }</td>
                        <td>${isAttending && rsvp.phone ? rsvp.phone : '-'}</td>
                        <td>${isAttending && rsvp.email ? rsvp.email : '-'}</td>
                        <td>${transportHTML}</td>
                        <td>${pickupHTML}</td>
                        <td class="rsvp-note-cell">${
                          isAttending && rsvp.note ? rsvp.note : '-'
                        }</td>
                        <td class="rsvp-timestamp-cell">${formattedDate}</td>
                    </tr>
                `;
          })
          .join('');

        rsvpListDiv.innerHTML = `
                <div class="rsvp-table-container">
                    <table class="rsvp-table">
                        <thead>
                            <tr>
                                <th>STT</th>
                                <th>T√™n</th>
                                <th>Tr·∫°ng th√°i</th>
                                <th>B√™n</th>
                                <th>S·ªë ng∆∞·ªùi</th>
                                <th>ƒêi·ªán tho·∫°i</th>
                                <th>Email</th>
                                <th>Ph∆∞∆°ng ti·ªán</th>
                                <th>ƒê·ªãa ƒëi·ªÉm ƒë√≥n</th>
                                <th>Ghi ch√∫</th>
                                <th>Th·ªùi gian</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                </div>
            `;
      }

      // Export RSVP data to CSV
      window.exportRsvpData = function () {
        if (allRsvpData.length === 0) {
          alert('Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t!');
          return;
        }

        const pickupLabels = {
          'cau-giay': 'C·∫ßu Gi·∫•y',
          'ha-dong': 'H√† ƒê√¥ng',
          'thai-thinh': 'Th√°i Th·ªãnh',
          'thanh-tri': 'Thanh Tr√¨',
        };

        // Create CSV header
        let csv = '\ufeff'; // UTF-8 BOM
        csv +=
          'STT,T√™n,B√™n,Tham d·ª±,S·ªë ng∆∞·ªùi,ƒêi·ªán tho·∫°i,Email,Ph∆∞∆°ng ti·ªán,ƒê·ªãa ƒëi·ªÉm ƒë√≥n,Ghi ch√∫,Th·ªùi gian\n';

        // Add data rows
        allRsvpData.forEach((rsvp, index) => {
          const sideLabel = rsvp.guestSide === 'groom' ? 'Nh√† trai' : 'Nh√† g√°i';
          const attendanceLabel = rsvp.attendance === 'yes' ? 'C√≥' : 'Kh√¥ng';
          const transportLabel =
            rsvp.transport === 'group'
              ? 'ƒê√≥n xe'
              : rsvp.transport === 'self'
              ? 'T·ª± ƒëi'
              : '-';
          const pickupLabel = rsvp.pickupLocation
            ? pickupLabels[rsvp.pickupLocation] || rsvp.pickupLocation
            : '-';
          const date = new Date(rsvp.timestamp).toLocaleString('vi-VN');

          csv += `${index + 1},"${
            rsvp.name
          }","${sideLabel}","${attendanceLabel}",`;
          csv += `"${rsvp.guestCount || '-'}","${rsvp.phone || '-'}","${
            rsvp.email || '-'
          }",`;
          csv += `"${transportLabel}","${pickupLabel}","${(
            rsvp.note || '-'
          ).replace(/"/g, '""')}","${date}"\n`;
        });

        // Download file
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `rsvp-responses-${
          new Date().toISOString().split('T')[0]
        }.csv`;
        link.click();
      };

      // Check auth on load
      if (sessionStorage.getItem('adminAuth') === 'true') {
        document.getElementById('loginScreen').style.display = 'none';
        document.getElementById('adminPanel').style.display = 'block';
        loadGuests();
        loadRsvpData();
      }

      // Enter key to login
      document
        .getElementById('passwordInput')
        .addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            window.login();
          }
        });

      // Enter key to add guest
      document
        .getElementById('guestNameInput')
        .addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            window.addGuest();
          }
        });

      // Search RSVP on input
      document.getElementById('rsvpSearch').addEventListener('input', () => {
        window.filterRsvps();
      });
    </script>
  </body>
</html>
